module.exports.config = {
  name: "azan",
  version: "3.2.0",
  credits: "Rakib & GPT-5.1",
  description: "ржЖржЬрж╛ржирзЗрж░ рж╕ржорзЯ рж╕ржм ржЧрзНрж░рзБржкрзЗ ржЗрж╕рж▓рж╛ржорж┐ржХ ржмрж╛рж░рзНрждрж╛ ржкрж╛ржарж╛рзЯ (ржнрж┐ржбрж┐ржУ ржЫрж╛рзЬрж╛)",
  commandCategory: "auto",
};

const prayerTimes = [
  { time: "05:35", name: "ЁЯМЕ ржлржЬрж░" },
  { time: "13:00", name: "тШАя╕П ржпрзЛрж╣рж░" },
  { time: "16:30", name: "ЁЯМд ржЖрж╕рж░" },
  { time: "19:05", name: "ЁЯМЗ ржорж╛ржЧрж░рж┐ржм" },
  { time: "20:15", name: "ЁЯМЩ ржЗрж╢рж╛" },
];

// ржЖржЬрж╛ржирзЗрж░ ржорзЗрж╕рзЗржЬ ржмрж╛ржирж┐рзЯрзЗ рж╕ржм ржЧрзНрж░рзБржкрзЗ ржкрж╛ржарж╛рзЯ
async function sendAzanToAllThreads(api, prayer) {
  const message = `
тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
ЁЯХМ *${prayer.name} ржирж╛ржорж╛ржЬрзЗрж░ рж╕ржорзЯ рж╣рзЯрзЗржЫрзЗ!*  
ЁЯХЛ тАЬрж╣рзЗ ржмрж┐рж╢рзНржмрж╛рж╕рзАржЧржг! ржирж╛ржорж╛ржЬ ржУ ржзрзИрж░рзНржпрзЗрж░ ржорж╛ржзрзНржпржорзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржкрзНрж░рж╛рж░рзНржержирж╛ ржХрж░рзЛредтАЭ  
ЁЯУЦ (рж╕рзВрж░рж╛ ржЖрж▓-ржмрж╛ржХрж╛рж░рж╛ рзи:рзкрзл)

ЁЯМ╕ ржЖрж▓рзНрж▓рж╛рж╣рж░ ржбрж╛ржХрзЗ рж╕рж╛рзЬрж╛ ржжрж╛ржУ тАФ ржирж╛ржорж╛ржЬрзЗ ржоржи ржжрж╛ржУ, ржПрждрзЗ рж╢рж╛ржирзНрждрж┐ ржЖржЫрзЗред  
ЁЯд▓ ржЖрж▓рзНрж▓рж╛рж╣ ржЖржорж╛ржжрзЗрж░ ржирж╛ржорж╛ржЬрзЗ ржоржирзЛржпрзЛржЧ ржУ ржирж┐рзЯржорж┐рждрждрж╛ ржжрж╛ржи ржХрж░рзБржиред
тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
  `.trim();

  try {
    let threadIDs = [];

    // ржпржжрж┐ ржмржЯрзЗрж░ рж╕рж┐рж╕рзНржЯрзЗржорзЗ рж╕ржм ржерзНрж░рзЗржб ржЖржЧрзЗржЗ рж╕рзЗржн ржерж╛ржХрзЗ
    if (global.data && Array.isArray(global.data.allThreadID)) {
      threadIDs = global.data.allThreadID;
    } else {
      // ржирж╛рж╣рж▓рзЗ API ржжрж┐рзЯрзЗ ржПржХржмрж╛рж░ рж▓рж┐рж╕рзНржЯ ржирзЗржмрзЗ (ржЕржирзЗржХ ржлрзНрж░рзЗржоржУрзЯрж╛рж░рзНржХрзЗ ржХрж╛ржЬ ржХрж░рзЗ)
      const threads = await api.getThreadList(100, null, ["INBOX"]);
      threadIDs = threads
        .filter(t => t.isGroup === true)   // рж╢рзБржзрзБ ржЧрзНрж░рзБржк
        .map(t => t.threadID);
    }

    // рж╕ржм ржЧрзНрж░рзБржкрзЗ ржкрж╛ржарж╛ржУ
    for (const tid of threadIDs) {
      api.sendMessage(message, tid);
    }

    console.log(`тЬЕ ${prayer.name} ржЖржЬрж╛ржи ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ ${threadIDs.length}ржЯрж╛ ржерзНрж░рзЗржбрзЗред`);
  } catch (err) {
    console.error("Azan broadcast error:", err);
  }
}

// ржмржЯ ржЕржи рж╣ржУрзЯрж╛ ржорж╛рждрзНрж░ржЗ ржЕржЯрзЛ рж╕рж┐рж╕рзНржЯрзЗржо ржЪрж╛рж▓рзБ рж╣ржмрзЗ
module.exports.onLoad = function ({ api }) {
  // ржбрж╛ржмрж▓ ржЗржиржЯрж╛рж░ржнрж╛рж▓ ржПрзЬрж┐рзЯрзЗ ржЪрж▓рж╛
  if (global.azanInterval) clearInterval(global.azanInterval);

  async function checkAndSend() {
    // ЁЯФе Asia/Dhaka ржЯрж╛ржЗржоржЬрзЛржи ржЕржирзБржпрж╛рзЯрзА рж╕ржорзЯ ржирж┐рж▓рж╛ржо
    const timeNow = new Date()
      .toLocaleTimeString("en-GB", {
        timeZone: "Asia/Dhaka",
        hour12: false,
        hour: "2-digit",
        minute: "2-digit",
      })
      .slice(0, 5); // "HH:MM"

    const match = prayerTimes.find(p => p.time === timeNow);
    if (match) {
      await sendAzanToAllThreads(api, match);
    }
  }

  // ржкрзНрж░рждрж┐ рзз ржорж┐ржирж┐ржЯрзЗ рж╕ржорзЯ ржорж┐рж▓рж┐рзЯрзЗ ржжрзЗржЦрзЗ
  global.azanInterval = setInterval(checkAndSend, 60 * 1000);

  console.log("тЬЕ ржЖржЬрж╛ржи ржЕржЯрзЛ ржмрзНрж░ржбржХрж╛рж╕рзНржЯ рж╕рж┐рж╕рзНржЯрзЗржо ржЪрж╛рж▓рзБ рж╣рзЯрзЗржЫрзЗ (рж╕ржм ржЧрзНрж░рзБржкрзЗ ржпрж╛ржмрзЗ)ред");
};

// ржХрзЗржЙ ржЪрж╛ржирзЗрж▓рзЗ/ржЧрзНрж░рзБржкрзЗ ржХржорж╛ржирзНржб ржжрж┐рж▓рзЗ рж╢рзБржзрзБ ржХржиржлрж╛рж░рзНржо ржХрж░ржмрзЗ
module.exports.run = async function ({ api, event }) {
  return api.sendMessage(
    "тЬЕ ржЖржЬрж╛ржи ржЕржЯрзЛ рж╕рж┐рж╕рзНржЯрзЗржо ржЪрж╛рж▓рзБ ржЖржЫрзЗред ржирж┐рж░рзНржзрж╛рж░рж┐ржд рж╕ржорзЯрзЗ рж╕ржм ржЧрзНрж░рзБржкрзЗ ржЖржЬрж╛ржи рж░рж┐ржорж╛ржЗржирзНржбрж╛рж░ ржпрж╛ржмрзЗ ржЗржирж╢рж╛ржЖрж▓рзНрж▓рж╛рж╣ред",
    event.threadID
  );
};
